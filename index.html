<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b1220" />
<title>AI Resume Search (Robust Loader + Fallback)</title>

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<!-- Universal Sentence Encoder -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:rgba(255,255,255,.08); --border:rgba(255,255,255,.14);
    --text:#e9eefc; --muted:rgba(233,238,252,.7); --chip:rgba(255,255,255,.10);
    --chipBorder:rgba(255,255,255,.18); --card:rgba(255,255,255,.07);
    --shadow:0 14px 40px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);padding:14px}
  .app{max-width:980px;margin:auto}
  header{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  h1{margin:0;font-size:20px}
  .sub{margin:6px 0 0;font-size:13px;color:var(--muted);line-height:1.35}
  .bar{margin-top:12px;display:grid;grid-template-columns:1fr auto;gap:10px}
  input[type="text"]{font-size:16px;padding:12px;border-radius:12px;background:rgba(255,255,255,.1);color:var(--text);border:1px solid var(--border);outline:none}
  button{background:rgba(255,255,255,.12);color:var(--text);border:1px solid var(--border);padding:12px 14px;border-radius:12px;cursor:pointer;touch-action:manipulation}
  .statusRow{margin-top:10px;display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:999px;background:#777}
  .dot.ok{background:#4ade80}
  .dot.warn{background:#facc15}
  .dot.bad{background:#fb7185}
  .status{font-size:13px;color:var(--muted)}
  .chips{display:flex;gap:8px;overflow-x:auto;margin-top:12px;padding-bottom:2px}
  .pill{border:1px solid var(--chipBorder);background:var(--chip);padding:8px 12px;border-radius:999px;font-size:13px;white-space:nowrap}
  #activeFilter{margin:12px 4px;font-size:13px;color:rgba(233,238,252,.9)}
  .results{margin-top:10px;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .cardTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  .badge{background:rgba(125,211,252,.12);border:1px solid rgba(125,211,252,.35);padding:6px 12px;border-radius:999px;font-size:13px;font-weight:700;flex:0 0 auto}
  .snippet{margin-top:10px;font-size:14px;line-height:1.45;color:rgba(233,238,252,.92)}
  .meta{margin-top:10px;font-size:12.5px;color:rgba(233,238,252,.65)}
  mark{background:rgba(250,204,21,.35);border-radius:4px;padding:2px 4px}
</style>
</head>

<body>
<div class="app">
  <header>
    <h1>AI Resume Search</h1>
    <p class="sub">
      Uses Universal Sentence Encoder when available; automatically falls back to keyword matching if the model can‚Äôt load
      (common in sandboxes/corporate networks).
    </p>

    <div class="bar">
      <input id="searchBox" type="text" placeholder="Try: C++ embedded linux, Java microservices, 5G telecom..." disabled />
      <button id="clearBtn">Clear</button>
    </div>

    <div class="statusRow" aria-live="polite">
      <div id="dot" class="dot"></div>
      <div id="status" class="status">Initializing‚Ä¶</div>
    </div>

    <div class="chips">
      <button class="pill" data-q="C++ embedded linux RTOS">C++ Embedded</button>
      <button class="pill" data-q="Java microservices spring boot">Java Backend</button>
      <button class="pill" data-q="Python machine learning MLOps">Python ML</button>
      <button class="pill" data-q="5G telecom LTE RF">5G Telecom</button>
    </div>
  </header>

  <div id="activeFilter">üîç Active Filter: <span id="filterText">None</span></div>
  <div id="results" class="results"></div>
</div>

<script>
/**
 * If your environment blocks Google Storage, host the model yourself and set these:
 * Example later (GitHub Pages or company server):
 *   CUSTOM_MODEL_URL = "./models/use/model.json"
 *   CUSTOM_VOCAB_URL = "./models/use/vocab.json"
 */
let CUSTOM_MODEL_URL = ""; // optional
let CUSTOM_VOCAB_URL = ""; // optional

let model = null;
let resumeEmbeddings = null;
let resumeNorms = null;

// ‚úÖ 25 sample resumes
const seedResumes = [
  { name: "Arjun Mehta", resumeText: `Senior C++ and Embedded Engineer, 8 years experience. Skills: C++, Embedded Linux, RTOS, CAN Bus, Automotive ECUs, ARM Microcontrollers, Telecommunication Protocols, Linux Kernel modules.` },
  { name: "Sophia Rodriguez", resumeText: `Java Backend Developer, 6 years experience. Skills: Java, Spring Boot, APIs, Microservices, Docker, Cloud, Kubernetes, SQL, Kafka.` },
  { name: "Ethan Williams", resumeText: `Telecom Engineer specialized in 5G and LTE. Skills: Telecommunication, RF Systems, 5G NR, LTE, Protocol Stack, Wireless Optimization.` },
  { name: "Mira Patel", resumeText: `Embedded Firmware Engineer with IoT background. Skills: C, C++, FreeRTOS, BLE, MQTT, STM32, PCB debugging.` },
  { name: "Daniel Chen", resumeText: `Python Developer & ML Engineer. Skills: Python, TensorFlow, React, APIs, Data Engineering, MLOps, Cloud deployment.` },

  { name: "Priya Sharma", resumeText: `Data Engineer with strong ETL background. Skills: Python, PySpark, Hadoop, Hive, Airflow, AWS Glue, Redshift.` },
  { name: "Carlos Gomez", resumeText: `Full Stack Developer. Skills: JavaScript, React, Node.js, Express, MongoDB, REST APIs, CI/CD.` },
  { name: "Emily Johnson", resumeText: `Cloud DevOps Engineer. Skills: AWS, Terraform, Docker, Kubernetes, CI/CD, Linux automation.` },
  { name: "Henry Thompson", resumeText: `QA Automation Engineer. Skills: Selenium, Cypress, Java, Python, Jenkins, API testing.` },
  { name: "Ravi Kumar", resumeText: `Network Engineer. Skills: Cisco, BGP, OSPF, SD-WAN, VPN, Firewalls, Network Security.` },

  { name: "Laura Smith", resumeText: `UX/UI Designer. Skills: Figma, Wireframing, User Research, Accessibility, Prototyping.` },
  { name: "Ahmed Ibrahim", resumeText: `Cybersecurity Analyst. Skills: SIEM, SOC monitoring, Incident Response, Vulnerability assessment, Firewalls.` },
  { name: "Jessica Lee", resumeText: `Machine Learning Engineer. Skills: Python, PyTorch, NLP, Computer Vision, Model Deployment, MLOps.` },
  { name: "David Park", resumeText: `Backend Developer. Skills: Go (Golang), Microservices, gRPC, REST, Docker, SQL, Redis.` },
  { name: "Harsh Verma", resumeText: `Automotive Controls Engineer. Skills: MATLAB, Simulink, CAN, AUTOSAR, ECU calibration, ISO 26262.` },

  { name: "Olivia Brown", resumeText: `Mobile Developer. Skills: Flutter, Dart, Android, iOS, Firebase, REST APIs.` },
  { name: "Benjamin Carter", resumeText: `FPGA Engineer. Skills: Verilog, VHDL, Xilinx, Vivado, High-speed design, Embedded Linux.` },
  { name: "Sara Khan", resumeText: `Robotics Engineer. Skills: ROS, Python, C++, SLAM, Sensors, Lidar, Control Systems.` },
  { name: "Nathan Wilson", resumeText: `Database Administrator. Skills: SQL Server, Performance tuning, Backup/Restore, Replication, Monitoring.` },
  { name: "Isabella Martinez", resumeText: `Business Analyst. Skills: Requirements, Jira, Confluence, User stories, Acceptance criteria, BPMN.` },

  { name: "George Miller", resumeText: `Linux System Administrator. Skills: Bash, Ansible, Networking, Monitoring, Security hardening.` },
  { name: "Yuki Tanaka", resumeText: `AI Intern. Skills: Python, Deep Learning, Transformers, Data preprocessing, Research.` },
  { name: "Michael Scott", resumeText: `Project Manager (PMP). Skills: Agile, Planning, Risk management, Stakeholder management.` },
  { name: "Anita Deshmukh", resumeText: `Embedded Test Engineer. Skills: HIL testing, CANalyzer, Vector tools, ECU validation, Python automation.` },
  { name: "Robert King", resumeText: `Java Architect. Skills: Java, Spring Cloud, Microservices, Cloud, High-performance systems, CI/CD.` },
];

function setStatus(msg, cls) {
  const dot = document.getElementById("dot");
  const status = document.getElementById("status");
  status.textContent = msg;
  dot.className = "dot" + (cls ? " " + cls : "");
}

function debounce(fn, ms) {
  let id;
  return (...args) => { clearTimeout(id); id = setTimeout(() => fn(...args), ms); };
}

function normalizeQuery(q) {
  return q
    .replace(/\bc\+\+\b/gi, "c++ cpp cplusplus c plus plus")
    .replace(/\bc#\b/gi, "c# csharp c sharp")
    .replace(/\.net/gi, ".net dotnet")
    .replace(/\s+/g, " ")
    .trim();
}

function tokenize(q) {
  return q.toLowerCase().replace(/[^\w\+\#\. ]+/g," ").split(/\s+/).filter(Boolean);
}

function keywordBoostScore(query, text) {
  const qTokens = tokenize(query);
  const hay = text.toLowerCase();
  if (!qTokens.length) return 0;

  let hits = 0;
  for (const t of qTokens) {
    const isKey = (t === "c++" || t === "cpp" || t === "c#" || t === ".net" || t === "dotnet");
    if (!isKey && t.length < 3) continue;
    if (hay.includes(t)) hits++;
  }
  return hits / Math.max(1, qTokens.length);
}

function generateSummary(text) {
  const clean = text.replace(/\s+/g, " ").trim();
  const firstSentence = clean.split(".")[0];
  const words = clean.split(" ").slice(0, 25).join(" ");
  return (firstSentence.length < 140 ? firstSentence : words) + "...";
}

function highlightSnippet(text, query) {
  const terms = Array.from(new Set(tokenize(query))).filter(t => t.length >= 3 || t === "c++" || t === "cpp" || t === "c#");
  let out = text.trim().replace(/\s+/g, " ");
  out = out.slice(0, 220) + (out.length > 220 ? "..." : "");
  for (const t of terms) {
    const safe = t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    out = out.replace(new RegExp(`(${safe})`, "ig"), "<mark>$1</mark>");
  }
  return out;
}

function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s += a[i]*b[i]; return s; }
function norm(a){ return Math.sqrt(dot(a,a)); }
function cosineSim(a,b, nb){ const na = norm(a); const denom = na * nb; return denom ? (dot(a,b)/denom) : 0; }

function timeout(ms) {
  return new Promise((_, reject) => setTimeout(() => reject(new Error("TIMEOUT")), ms));
}

async function loadUSE() {
  setStatus("Preparing TensorFlow‚Ä¶", "");
  await tf.ready();
  try { await tf.setBackend("webgl"); } catch (_) {}
  await tf.ready();

  setStatus("Loading AI model‚Ä¶ (may be blocked in this environment)", "");
  const cfg = (CUSTOM_MODEL_URL && CUSTOM_VOCAB_URL)
    ? { modelUrl: CUSTOM_MODEL_URL, vocabUrl: CUSTOM_VOCAB_URL }
    : undefined;

  // Important: If downloads are blocked, this avoids ‚Äúinfinite loading‚Äù
  model = await Promise.race([
    cfg ? use.load(cfg) : use.load(),
    timeout(25000)
  ]);
}

async function indexResumes() {
  setStatus("Indexing resumes‚Ä¶", "");
  const texts = seedResumes.map(r => r.resumeText);
  const emb = await model.embed(texts);
  resumeEmbeddings = await emb.array();
  emb.dispose();
  resumeNorms = resumeEmbeddings.map(v => norm(v));
}

async function init() {
  const searchBox = document.getElementById("searchBox");
  searchBox.disabled = true;

  try {
    await loadUSE();
    await indexResumes();
    setStatus("AI Ready ‚úÖ  (semantic + keyword)", "ok");
  } catch (e) {
    console.warn(e);
    model = null;
    resumeEmbeddings = null;
    resumeNorms = null;

    if (String(e?.message).includes("TIMEOUT")) {
      setStatus("AI model blocked/too slow here ‚Üí using keyword fallback ‚úÖ", "warn");
    } else {
      setStatus("AI load failed ‚Üí using keyword fallback ‚úÖ", "warn");
    }
  }

  searchBox.disabled = false;
  searchBox.value = "C++ embedded linux";
  await searchAndRender(searchBox.value);
}

async function embedQuery(q) {
  const t = await model.embed([q]);
  const arr = await t.array();
  t.dispose();
  return arr[0];
}

async function searchAndRender(rawQuery) {
  document.getElementById("filterText").textContent = rawQuery || "None";
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  const q0 = rawQuery.trim();
  if (!q0) return;

  const query = normalizeQuery(q0);
  const isSymbolSkillQuery = /\bc\+\+\b|\bc#\b|\.net/i.test(q0);
  const shortQuery = tokenize(query).length <= 2;

  let qVec = null;
  if (model && resumeEmbeddings) {
    qVec = await embedQuery(query);
  }

  const wKeyword = (isSymbolSkillQuery || shortQuery || !qVec) ? 0.70 : 0.30;
  const wSemantic = 1 - wKeyword;

  const scored = seedResumes.map((r, i) => {
    const kw = keywordBoostScore(query, r.resumeText);
    const sem = (qVec && resumeEmbeddings) ? Math.max(0, cosineSim(qVec, resumeEmbeddings[i], resumeNorms[i])) : 0;
    const score = (wSemantic * sem) + (wKeyword * kw);
    return { ...r, kw, sem, score };
  }).sort((a,b) => b.score - a.score);

  for (const c of scored) {
    const card = document.createElement("div");
    card.className = "card";

    const scorePct = (c.score * 100).toFixed(1);
    const semPct = (c.sem * 100).toFixed(1);
    const kwPct  = (c.kw * 100).toFixed(1);

    card.innerHTML = `
      <div class="cardTop">
        <h3 style="margin:0">${c.name}</h3>
        <div class="badge">${scorePct}%</div>
      </div>

      <div class="snippet">
        <strong>Summary:</strong><br/>
        ${generateSummary(c.resumeText)}
      </div>

      <div class="snippet" style="margin-top:10px;">
        <strong>Match Snippet:</strong><br/>
        ${highlightSnippet(c.resumeText, query)}
      </div>

      <div class="meta">Semantic: ${semPct}% ‚Ä¢ Skill-hit: ${kwPct}%</div>
    `;
    resultsDiv.appendChild(card);
  }
}

const searchBox = document.getElementById("searchBox");
searchBox.addEventListener("input", debounce(() => searchAndRender(searchBox.value), 250));

document.getElementById("clearBtn").addEventListener("click", () => {
  searchBox.value = "";
  document.getElementById("results").innerHTML = "";
  document.getElementById("filterText").textContent = "None";
  searchBox.focus();
});

document.querySelectorAll(".pill").forEach(btn => {
  btn.addEventListener("click", () => {
    searchBox.value = btn.dataset.q;
    searchAndRender(searchBox.value);
    searchBox.focus();
  });
});

init();
</script>
</body>
</html>
